<?php

/* This file is part of Jeedom.
 *
 * JEEDOM is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Jeedom is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Jeedom. If not, see <http://www.gnu.org/licenses/>.
 */

/* * ***************************Includes********************************* */
require_once __DIR__ . '/../../../../core/php/core.inc.php';
require_once __DIR__ . '/../../3rdparty/sabnzbd_api.class.php';

class sabnzbd extends eqLogic {
    /*     * *************************Attributs****************************** */

    /*     * ***********************Methode static*************************** */
    public static function postConfig_password() {
        sabnzbd::force_detect_softners();
    }

    public static function force_detect_softners() {
        // Initialisation de la connexion
        if ( config::byKey('account', 'sabnzbd') != "" || config::byKey('password', 'sabnzbd') != "" )
        {
            $session_sabnzbd = new sabnzbd_api();
	    $session_sabnzbd->login(config::byKey('account', 'sabnzbd'), config::byKey('password', 'sabnzbd'));
	    $tok = $session_sabnzbd->get_Token();
	    $content = $session_sabnzbd->GetSofteners();
            $ListOfSoftners = json_decode($content, true);

	    $i=0;
	    if (!is_array($ListOfSoftners) ) {
                log::add('sabnzbd','info','No Softtner associated to this account ??');
		return true;
	    }
						                  }
            foreach ($ListOfSoftners as $Softner )
            {
                $dsn=$Softner["device"]["dsn"];
		$id=$Softner["device"]["key"];
	        $details = $session_sabnzbd->GetDetailSofteners($dsn);
                $LisDetailsSoftner = json_decode($details, true);
            	foreach ($LisDetailsSoftner as $DetailsSoftner )
		{
			if ($DetailsSoftner["datum"]["key"] == "nickname")
		            $nickname = $DetailsSoftner["datum"]["value"];
			if ($DetailsSoftner["datum"]["key"] == "modelDesc")
		            $modelDesc = $DetailsSoftner["datum"]["value"];
			if ($DetailsSoftner["datum"]["key"] == "systemType")
		            $systemType = $DetailsSoftner["datum"]["value"];
		}
                if ( ! is_object(self::byLogicalId($id, 'sabnzbd')) ) {
                log::add('sabnzbd','info','adding new Softtner : '.$dsn);
                    $eqLogic = new sabnzbd();
                    $eqLogic->setLogicalId($id);
                    $eqLogic->setName($nickname);
                    $eqLogic->setEqType_name('sabnzbd');
                    $eqLogic->setIsEnable(1);
                    $eqLogic->setIsVisible(1);
		    $eqLogic->setConfiguration('DSN',$dsn);
                log::add('sabnzbd','info','adding new Softtner .. ');
                    $eqLogic->setConfiguration('Maxtreated',10);
                log::add('sabnzbd','info','adding new Softtner ... ');
		    $eqLogic->setConfiguration('Token',$tok);
		    //$eqLogic->setStatus('DSN', $dsn);
		    $eqLogic->setConfiguration('modelDesc',$modelDesc);
		    $eqLogic->setConfiguration('systemType',$systemType);
                    $eqLogic->save();
                    $eqLogic->pull();
                    $eqLogic->save();
		}

            }
        }

    public function postInsert()
    {
        $this->postUpdate();
        $this->scan();
    }

    private function getListDefaultCmd()
    {
        return array(   "speed" => array('speed', 'info', 'numeric', "KB/S", 0, "GENERIC_INFO", 'jauge', 'jauge', 'A',1,12000),
		"status" => array('status', 'info', 'string', "", 0, "GENERIC_INFO", 'badge','badge', 'B',0,0),
		"action" => array('Commande', 'action', 'select', "", 0, "GENERIC_ACTION", '', '', 'pause|'.__('Pause Sabnzbd',__FILE__).';resume|'.__('Resume',__FILE__).';shutdown|'.__('Shutdown',__FILE__))
        );
    }

    public function postUpdate()
    {
        foreach( $this->getListDefaultCmd() as $id => $data)
	{
	    list($name, $type, $subtype, $unit, $invertBinary, $generic_type, $template_dashboard, $template_mobile, $listValue, $multiplier,$maxValue) = $data;
            $cmd = $this->getCmd(null, $id);
            if ( ! is_object($cmd) ) {
                $cmd = new sabnzbdCmd();
                $cmd->setName($name);
                $cmd->setEqLogic_id($this->getId());
		$cmd->setType($type);
		$cmd->setUnite($unit);
		$cmd->setIsHistorized(1);
                $cmd->setSubType($subtype);
                $cmd->setLogicalId($id);
                       // $cmd->setCollectDate('');
                if ( $listValue != "" )
                {
                    $cmd->setConfiguration('listValue', $listValue);
                }
                $cmd->setDisplay('invertBinary',$invertBinary);
                $cmd->setConfiguration('maxValue',$maxValue);
		$cmd->setDisplay('generic_type', $generic_type);
                $cmd->setTemplate('dashboard', $template_dashboard);
                $cmd->setTemplate('mobile', $template_mobile);
                $cmd->save();
            }
            else
            {
                if ( $cmd->getType() == "" )
                {
                    $cmd->setType($type);
                }
                if ( $cmd->getSubType() == "" )
                {
                    $cmd->setSubType($subtype);
                }
                if ( $cmd->getDisplay('invertBinary') == "" )
                {
                    $cmd->setDisplay('invertBinary',$invertBinary);
                }
                if ( $cmd->getDisplay('generic_type') == "" )
                {
                    $cmd->setDisplay('generic_type', $generic_type);
                }
                if ( $cmd->getDisplay('dashboard') == "" )
                {
                    $cmd->setTemplate('dashboard', $template_dashboard);
                }
                if ( $cmd->getDisplay('mobile') == "" )
                {
                    $cmd->setTemplate('mobile', $template_mobile);
                }
                if ( $listValue != "" )
                {
                    $cmd->setConfiguration('listValue', $listValue);
                }
                $cmd->save();
            }
        }
    }

    public function preRemove() {
    }

    public static function pull() {
            foreach (self::byType('sabnzbd') as $eqLogic) {
                $eqLogic->scan();
            }
    }

    public function scan() {
	$factor=array("M"=>1000, "K"=>1);

	    	
        $session_sabnzbd = new sabnzbd_api();
        $session_sabnzbd->set_Token($this->getConfiguration('Token'));
        if ( $this->getIsEnable() ) {
	    log::add('sabnzbd','info',"  set API =  ".$this->getConfiguration('API'));
	    $DataSabnzbd = $session_sabnzbd->login($this->getConfiguration('host'),$this->getConfiguration('port'),$this->getConfiguration('API'),"queue");

	    $QueuesInfo = json_decode($DataSabnzbd, true);
             
                foreach( $this->getListDefaultCmd() as $id => $data)
                {
			list($name, $type, $subtype, $unit, $invertBinary, $generic_type, $template_dashboard, $template_mobile, $listValue, $multiplier,$maxValue) = $data;
			##$this->checkAndUpdateCmd($id,$queue_info["queue"][$id]);
			$val = $QueuesInfo["queue"][$id];
			if ($id == "speed") {
			   log::add('sabnzbd','info'," inti val =  ".$val);
			    if ($val == "") { 
				$val = "0.0 M";
			    }
                           $unit = substr($val, -1);
                           $kb = substr($val, 0,-2) * $factor[$unit];
			   $this->checkAndUpdateCmd($id,$kb);
                           $this->save();
			   
			}
			if ($id == "status") {
				$this->checkAndUpdateCmd($id,$QueuesInfo["queue"][$id]);
                                $this->save();
			}
		}
	}
    }
}

class sabnzbdCmd extends cmd 
{
    /*     * *************************Attributs****************************** */
	public function execute($_options = null) {

        if ( $this->getLogicalId() == 'action' && $_options['select'] != "" )
        {
		log::add('sabnzbd','info',"Commande execute ".$this->getLogicalId()." ".$_options['select']);
		$eqLogic = $this->getEqLogic();
		$session_cmd = new sabnzbd_api();
	        $session_cmd->login($eqLogic->getConfiguration('host'),$eqLogic->getConfiguration('port'),$eqLogic->getConfiguration('API'),$_options['select']);
                $eqLogic->scan();
        }
    }


    /*     * ***********************Methode static*************************** */


    /*     * *********************Methode d'instance************************* */

    /*     * **********************Getteur Setteur*************************** */
}
 
